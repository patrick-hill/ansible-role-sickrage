---

- name: Install Requirements
  yum:
    pkg: "{{ item }}"
    state: installed
  with_items:
    - python-cheetah
    - python-setproctitle
  become: true
    
- name: Install Dependencies w/ pip
  command: pip install pyopenssl
  become: true

- name: Clone repo from GitHub
  git:
    repo: "{{ sickrage_repo }}"
    dest: "{{ sickrage_install_dir }}"
    version: master
  become: true

- name: Create data dir
  file:
    path: "{{ sickrage_config_dir }}"
    owner: "{{ sickrage_user }}"
    group: "{{ sickrage_group }}"
    recurse: yes
    state: directory
    mode: '0755'
  become: true

- name: Restore Backup --> Extract archive
  unarchive:
    src: "{{ sickrage_restore_file }}"
    dest: "{{ sickrage_config_dir }}"
    copy: no
  become: true
  when: sickrage_restore_file is defined

- name: Set dir owner
  file: 
    path: "{{ sickrage_install_dir }}"
    owner: "{{ sickrage_user }}"
    group: "{{ sickrage_group }}"
    recurse: yes
    state: directory
    mode: '0755'

- name: Enable port on firewall
  command: "{{ item }}"
  with_items:
    - firewall-cmd --permanent --add-port=8081/tcp  # HTTP port
#    - firewall-cmd --permanent --add-port=9090/tcp  # HTTPS port
    - firewall-cmd --reload
  become: true
  when: sickrage_firewall_enabled

- name: Add service
  template:
    src: sickrage.service.j2
    dest: /etc/systemd/system/sickrage.service
    owner: root
    group: root
    mode: '0644'
  become: true

- name:     Enable service
  service:
    name: sickrage.service
    enabled: yes
    state: started
  become: true
